import{v4 as e}from"uuid";var t=async(e,t=Object.create(null))=>{const{all:n=!1,dot:a=!1}=t,i=(e instanceof b?e.raw.headers:e.headers).get("Content-Type");return null!==i&&i.startsWith("multipart/form-data")||null!==i&&i.startsWith("application/x-www-form-urlencoded")?async function(e,t){const n=await e.formData();if(n)return function(e,t){const n=Object.create(null);e.forEach(((e,s)=>{t.all||s.endsWith("[]")?r(n,s,e):n[s]=e})),t.dot&&Object.entries(n).forEach((([e,t])=>{e.includes(".")&&(s(n,e,t),delete n[e])}));return n}(n,t);return{}}(e,{all:n,dot:a}):{}};var r=(e,t,r)=>{void 0!==e[t]?Array.isArray(e[t])?e[t].push(r):e[t]=[e[t],r]:e[t]=r},s=(e,t,r)=>{let s=e;const n=t.split(".");n.forEach(((e,t)=>{t===n.length-1?s[e]=r:((!s[e]||"object"!=typeof s[e]||Array.isArray(s[e])||s[e]instanceof File)&&(s[e]=Object.create(null)),s=s[e])}))},n=e=>{const t=e.split("/");return""===t[0]&&t.shift(),t},a=e=>{const t=[];return e=e.replace(/\{[^}]+\}/g,((e,r)=>{const s=`@${r}`;return t.push([s,e]),s})),{groups:t,path:e}},i=(e,t)=>{for(let r=t.length-1;r>=0;r--){const[s]=t[r];for(let n=e.length-1;n>=0;n--)if(e[n].includes(s)){e[n]=e[n].replace(s,t[r][1]);break}}return e},o={},h=e=>{if("*"===e)return"*";const t=e.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);return t?(o[e]||(t[2]?o[e]=[e,t[1],new RegExp("^"+t[2]+"$")]:o[e]=[e,t[1],!0]),o[e]):null},c=e=>{try{return decodeURI(e)}catch{return e.replace(/(?:%[0-9A-Fa-f]{2})+/g,(e=>{try{return decodeURI(e)}catch{return e}}))}},d=e=>{const t=e.url,r=t.indexOf("/",8);let s=r;for(;s<t.length;s++){const e=t.charCodeAt(s);if(37===e){const e=t.indexOf("?",s),n=t.slice(r,-1===e?void 0:e);return c(n.includes("%25")?n.replace(/%25/g,"%2525"):n)}if(63===e)break}return t.slice(r,s)},u=e=>{const t=d(e);return t.length>1&&"/"===t[t.length-1]?t.slice(0,-1):t},l=(...e)=>{let t="",r=!1;for(let s of e)"/"===t[t.length-1]&&(t=t.slice(0,-1),r=!0),"/"!==s[0]&&(s=`/${s}`),"/"===s&&r?t=`${t}/`:"/"!==s&&(t=`${t}${s}`),"/"===s&&""===t&&(t="/");return t},p=e=>{if(!e.match(/\:.+\?$/))return null;const t=e.split("/"),r=[];let s="";return t.forEach((e=>{if(""===e||/\:/.test(e)){if(/\:/.test(e))if(/\?/.test(e)){0===r.length&&""===s?r.push("/"):r.push(s);const t=e.replace("?","");s+="/"+t,r.push(s)}else s+="/"+e}else s+="/"+e})),r.filter(((e,t,r)=>r.indexOf(e)===t))},f=e=>/[%+]/.test(e)?(-1!==e.indexOf("+")&&(e=e.replace(/\+/g," ")),/%/.test(e)?w(e):e):e,m=(e,t,r)=>{let s;if(!r&&t&&!/[%+]/.test(t)){let r=e.indexOf(`?${t}`,8);for(-1===r&&(r=e.indexOf(`&${t}`,8));-1!==r;){const s=e.charCodeAt(r+t.length+1);if(61===s){const s=r+t.length+2,n=e.indexOf("&",s);return f(e.slice(s,-1===n?void 0:n))}if(38==s||isNaN(s))return"";r=e.indexOf(`&${t}`,r+1)}if(s=/[%+]/.test(e),!s)return}const n={};s??=/[%+]/.test(e);let a=e.indexOf("?",8);for(;-1!==a;){const t=e.indexOf("&",a+1);let i=e.indexOf("=",a);i>t&&-1!==t&&(i=-1);let o,h=e.slice(a+1,-1===i?-1===t?void 0:t:i);(s&&(h=f(h)),a=t,""!==h)&&(-1===i?o="":(o=e.slice(i+1,-1===t?void 0:t),s&&(o=f(o))),r?(n[h]&&Array.isArray(n[h])||(n[h]=[]),n[h].push(o)):n[h]??=o)}return t?n[t]:n},g=m,w=decodeURIComponent,b=class{raw;#e;#t;routeIndex=0;path;bodyCache={};constructor(e,t="/",r=[[]]){this.raw=e,this.path=t,this.#t=r,this.#e={}}param(e){return e?this.getDecodedParam(e):this.getAllDecodedParams()}getDecodedParam(e){const t=this.#t[0][this.routeIndex][1][e],r=this.getParamValue(t);return r?/\%/.test(r)?w(r):r:void 0}getAllDecodedParams(){const e={},t=Object.keys(this.#t[0][this.routeIndex][1]);for(const r of t){const t=this.getParamValue(this.#t[0][this.routeIndex][1][r]);t&&"string"==typeof t&&(e[r]=/\%/.test(t)?w(t):t)}return e}getParamValue(e){return this.#t[1]?this.#t[1][e]:e}query(e){return g(this.url,e)}queries(e){return((e,t)=>m(e,t,!0))(this.url,e)}header(e){if(e)return this.raw.headers.get(e.toLowerCase())??void 0;const t={};return this.raw.headers.forEach(((e,r)=>{t[r]=e})),t}async parseBody(e){return this.bodyCache.parsedBody??=await t(this,e)}cachedBody=e=>{const{bodyCache:t,raw:r}=this,s=t[e];if(s)return s;const n=Object.keys(t)[0];return n?t[n].then((t=>("json"===n&&(t=JSON.stringify(t)),new Response(t)[e]()))):t[e]=r[e]()};json(){return this.cachedBody("json")}text(){return this.cachedBody("text")}arrayBuffer(){return this.cachedBody("arrayBuffer")}blob(){return this.cachedBody("blob")}formData(){return this.cachedBody("formData")}addValidatedData(e,t){this.#e[e]=t}valid(e){return this.#e[e]}get url(){return this.raw.url}get method(){return this.raw.method}get matchedRoutes(){return this.#t[0].map((([[,e]])=>e))}get routePath(){return this.#t[0].map((([[,e]])=>e))[this.routeIndex].path}},y=1,x=async(e,t,r,s,n)=>{const a=e.callbacks;if(!a?.length)return Promise.resolve(e);n?n[0]+=e:n=[e];return Promise.all(a.map((e=>e({phase:t,buffer:n,context:s})))).then((e=>Promise.all(e.filter(Boolean).map((e=>x(e,t,!1,s,n)))).then((()=>n[0]))))},R=(e,t={})=>(Object.entries(t).forEach((([t,r])=>e.set(t,r))),e),v=class{#r;#s;env={};#n;finalized=!1;error;#a=200;#i;#o;#h;#c;#d=!0;#u;#l;#p;#t;#f;constructor(e,t){this.#r=e,t&&(this.#i=t.executionCtx,this.env=t.env,this.#p=t.notFoundHandler,this.#f=t.path,this.#t=t.matchResult)}get req(){return this.#s??=new b(this.#r,this.#f,this.#t),this.#s}get event(){if(this.#i&&"respondWith"in this.#i)return this.#i;throw Error("This context has no FetchEvent")}get executionCtx(){if(this.#i)return this.#i;throw Error("This context has no ExecutionContext")}get res(){return this.#d=!1,this.#c||=new Response("404 Not Found",{status:404})}set res(e){if(this.#d=!1,this.#c&&e){this.#c.headers.delete("content-type");for(const[t,r]of this.#c.headers.entries())if("set-cookie"===t){const t=this.#c.headers.getSetCookie();e.headers.delete("set-cookie");for(const r of t)e.headers.append("set-cookie",r)}else e.headers.set(t,r)}this.#c=e,this.finalized=!0}render=(...e)=>(this.#l??=e=>this.html(e),this.#l(...e));setLayout=e=>this.#u=e;getLayout=()=>this.#u;setRenderer=e=>{this.#l=e};header=(e,t,r)=>{if(void 0===t)return this.#o?this.#o.delete(e):this.#h&&delete this.#h[e.toLocaleLowerCase()],void(this.finalized&&this.res.headers.delete(e));r?.append?(this.#o||(this.#d=!1,this.#o=new Headers(this.#h),this.#h={}),this.#o.append(e,t)):this.#o?this.#o.set(e,t):(this.#h??={},this.#h[e.toLowerCase()]=t),this.finalized&&(r?.append?this.res.headers.append(e,t):this.res.headers.set(e,t))};status=e=>{this.#d=!1,this.#a=e};set=(e,t)=>{this.#n??={},this.#n[e]=t};get=e=>this.#n?this.#n[e]:void 0;get var(){return{...this.#n}}newResponse=(e,t,r)=>{if(this.#d&&!r&&!t&&200===this.#a)return new Response(e,{headers:this.#h});if(t&&"number"!=typeof t){const r=new Headers(t.headers);this.#o&&this.#o.forEach(((e,t)=>{"set-cookie"===t?r.append(t,e):r.set(t,e)}));const s=R(r,this.#h);return new Response(e,{headers:s,status:t.status??this.#a})}const s="number"==typeof t?t:this.#a;this.#h??={},this.#o??=new Headers,R(this.#o,this.#h),this.#c&&(this.#c.headers.forEach(((e,t)=>{"set-cookie"===t?this.#o?.append(t,e):this.#o?.set(t,e)})),R(this.#o,this.#h)),r??={};for(const[e,t]of Object.entries(r))if("string"==typeof t)this.#o.set(e,t);else{this.#o.delete(e);for(const r of t)this.#o.append(e,r)}return new Response(e,{status:s,headers:this.#o})};body=(e,t,r)=>"number"==typeof t?this.newResponse(e,t,r):this.newResponse(e,t);text=(e,t,r)=>{if(!this.#h){if(this.#d&&!r&&!t)return new Response(e);this.#h={}}return this.#h["content-type"]="text/plain; charset=UTF-8","number"==typeof t?this.newResponse(e,t,r):this.newResponse(e,t)};json=(e,t,r)=>{const s=JSON.stringify(e);return this.#h??={},this.#h["content-type"]="application/json; charset=UTF-8","number"==typeof t?this.newResponse(s,t,r):this.newResponse(s,t)};html=(e,t,r)=>(this.#h??={},this.#h["content-type"]="text/html; charset=UTF-8","object"==typeof e&&(e instanceof Promise||(e=e.toString()),e instanceof Promise)?e.then((e=>x(e,y,!1,{}))).then((e=>"number"==typeof t?this.newResponse(e,t,r):this.newResponse(e,t))):"number"==typeof t?this.newResponse(e,t,r):this.newResponse(e,t));redirect=(e,t)=>(this.#o??=new Headers,this.#o.set("Location",e),this.newResponse(null,t??302));notFound=()=>(this.#p??=()=>new Response,this.#p(this))},j=(e,t,r)=>(s,n)=>{let a=-1;return async function i(o){if(o<=a)throw new Error("next() called multiple times");let h;a=o;let c,d=!1;e[o]?(c=e[o][0][0],s instanceof v&&(s.req.routeIndex=o)):c=o===e.length&&n||void 0;if(c)try{h=await c(s,(()=>i(o+1)))}catch(e){if(!(e instanceof Error&&s instanceof v&&t))throw e;s.error=e,h=await t(e,s),d=!0}else s instanceof v&&!1===s.finalized&&r&&(h=await r(s));h&&(!1===s.finalized||d)&&(s.res=h);return s}(0)},O="ALL",E=["get","post","put","delete","options","patch"],H="Can not add a route since the matcher is already built.",k=class extends Error{},_=Symbol("composedHandler"),$=e=>e.text("404 Not Found",404),F=(e,t)=>"getResponse"in e?e.getResponse():t.text("Internal Server Error",500),P=class{get;post;put;delete;options;patch;all;on;use;router;getPath;_basePath="/";#f="/";routes=[];constructor(e={}){[...E,"all"].forEach((e=>{this[e]=(t,...r)=>("string"==typeof t?this.#f=t:this.addRoute(e,this.#f,t),r.forEach((t=>{"string"!=typeof t&&this.addRoute(e,this.#f,t)})),this)})),this.on=(e,t,...r)=>{for(const s of[t].flat()){this.#f=s;for(const t of[e].flat())r.map((e=>{this.addRoute(t.toUpperCase(),this.#f,e)}))}return this},this.use=(e,...t)=>("string"==typeof e?this.#f=e:(this.#f="*",t.unshift(e)),t.forEach((e=>{this.addRoute(O,this.#f,e)})),this);const t=e.strict??!0;delete e.strict,Object.assign(this,e),this.getPath=t?e.getPath??d:u}clone(){const e=new P({router:this.router,getPath:this.getPath});return e.routes=this.routes,e}notFoundHandler=$;errorHandler=F;route(e,t){const r=this.basePath(e);return t.routes.map((e=>{let s;t.errorHandler===F?s=e.handler:(s=async(r,s)=>(await j([],t.errorHandler)(r,(()=>e.handler(r,s)))).res,s[_]=e.handler),r.addRoute(e.method,e.path,s)})),this}basePath(e){const t=this.clone();return t._basePath=l(this._basePath,e),t}onError=e=>(this.errorHandler=e,this);notFound=e=>(this.notFoundHandler=e,this);mount(e,t,r){let s,n;r&&("function"==typeof r?n=r:(n=r.optionHandler,s=r.replaceRequest));const a=n?e=>{const t=n(e);return Array.isArray(t)?t:[t]}:e=>{let t;try{t=e.executionCtx}catch{}return[e.env,t]};s||=(()=>{const t=l(this._basePath,e),r="/"===t?0:t.length;return e=>{const t=new URL(e.url);return t.pathname=t.pathname.slice(r)||"/",new Request(t,e)}})();return this.addRoute(O,l(e,"*"),(async(e,r)=>{const n=await t(s(e.req.raw),...a(e));if(n)return n;await r()})),this}addRoute(e,t,r){e=e.toUpperCase();const s={path:t=l(this._basePath,t),method:e,handler:r};this.router.add(e,t,[r,s]),this.routes.push(s)}matchRoute(e,t){return this.router.match(e,t)}handleError(e,t){if(e instanceof Error)return this.errorHandler(e,t);throw e}dispatch(e,t,r,s){if("HEAD"===s)return(async()=>new Response(null,await this.dispatch(e,t,r,"GET")))();const n=this.getPath(e,{env:r}),a=this.matchRoute(s,n),i=new v(e,{path:n,matchResult:a,env:r,executionCtx:t,notFoundHandler:this.notFoundHandler});if(1===a[0].length){let e;try{e=a[0][0][0][0](i,(async()=>{i.res=await this.notFoundHandler(i)}))}catch(e){return this.handleError(e,i)}return e instanceof Promise?e.then((e=>e||(i.finalized?i.res:this.notFoundHandler(i)))).catch((e=>this.handleError(e,i))):e??this.notFoundHandler(i)}const o=j(a[0],this.errorHandler,this.notFoundHandler);return(async()=>{try{const e=await o(i);if(!e.finalized)throw new Error("Context is not finalized. Did you forget to return a Response object or `await next()`?");return e.res}catch(e){return this.handleError(e,i)}})()}fetch=(e,...t)=>this.dispatch(e,t[1],t[0],e.method);request=(e,t,r,s)=>{if(e instanceof Request)return void 0!==t&&(e=new Request(e,t)),this.fetch(e,r,s);e=e.toString();const n=/^https?:\/\//.test(e)?e:`http://localhost${l("/",e)}`,a=new Request(n,t);return this.fetch(a,r,s)};fire=()=>{addEventListener("fetch",(e=>{e.respondWith(this.dispatch(e.request,e,void 0,e.request.method))}))}},q="[^/]+",C=".*",S="(?:|/.*)",A=Symbol(),I=new Set(".\\+*[^]$()");function B(e,t){return 1===e.length?1===t.length?e<t?-1:1:-1:1===t.length||e===C||e===S?1:t===C||t===S?-1:e===q?1:t===q?-1:e.length===t.length?e<t?-1:1:t.length-e.length}var D=class{index;varIndex;children=Object.create(null);insert(e,t,r,s,n){if(0===e.length){if(void 0!==this.index)throw A;if(n)return;return void(this.index=t)}const[a,...i]=e,o="*"===a?0===i.length?["","",C]:["","",q]:"/*"===a?["","",S]:a.match(/^\:([^\{\}]+)(?:\{(.+)\})?$/);let h;if(o){const e=o[1];let t=o[2]||q;if(e&&o[2]&&(t=t.replace(/^\((?!\?:)(?=[^)]+\)$)/,"(?:"),/\((?!\?:)/.test(t)))throw A;if(h=this.children[t],!h){if(Object.keys(this.children).some((e=>e!==C&&e!==S)))throw A;if(n)return;h=this.children[t]=new D,""!==e&&(h.varIndex=s.varIndex++)}n||""===e||r.push([e,h.varIndex])}else if(h=this.children[a],!h){if(Object.keys(this.children).some((e=>e.length>1&&e!==C&&e!==S)))throw A;if(n)return;h=this.children[a]=new D}h.insert(i,t,r,s,n)}buildRegExpStr(){const e=Object.keys(this.children).sort(B).map((e=>{const t=this.children[e];return("number"==typeof t.varIndex?`(${e})@${t.varIndex}`:I.has(e)?`\\${e}`:e)+t.buildRegExpStr()}));return"number"==typeof this.index&&e.unshift(`#${this.index}`),0===e.length?"":1===e.length?e[0]:"(?:"+e.join("|")+")"}},z=class{context={varIndex:0};root=new D;insert(e,t,r){const s=[],n=[];for(let t=0;;){let r=!1;if(e=e.replace(/\{[^}]+\}/g,(e=>{const s=`@\\${t}`;return n[t]=[s,e],t++,r=!0,s})),!r)break}const a=e.match(/(?::[^\/]+)|(?:\/\*$)|./g)||[];for(let e=n.length-1;e>=0;e--){const[t]=n[e];for(let r=a.length-1;r>=0;r--)if(-1!==a[r].indexOf(t)){a[r]=a[r].replace(t,n[e][1]);break}}return this.root.insert(a,t,s,this.context,r),s}buildRegExp(){let e=this.root.buildRegExpStr();if(""===e)return[/^$/,[],[]];let t=0;const r=[],s=[];return e=e.replace(/#(\d+)|@(\d+)|\.\*\$/g,((e,n,a)=>void 0!==n?(r[++t]=Number(n),"$()"):void 0!==a?(s[Number(a)]=++t,""):"")),[new RegExp(`^${e}`),r,s]}},L=[],U=[/^$/,[],Object.create(null)],T=Object.create(null);function N(e){return T[e]??=new RegExp("*"===e?"":`^${e.replace(/\/\*$|([.\\+*[^\]$()])/g,((e,t)=>t?`\\${t}`:"(?:|/.*)"))}$`)}function W(e,t){if(e)for(const r of Object.keys(e).sort(((e,t)=>t.length-e.length)))if(N(r).test(t))return[...e[r]]}var M=class{name="RegExpRouter";middleware;routes;constructor(){this.middleware={[O]:Object.create(null)},this.routes={[O]:Object.create(null)}}add(e,t,r){const{middleware:s,routes:n}=this;if(!s||!n)throw new Error(H);s[e]||[s,n].forEach((t=>{t[e]=Object.create(null),Object.keys(t[O]).forEach((r=>{t[e][r]=[...t[O][r]]}))})),"/*"===t&&(t="*");const a=(t.match(/\/:/g)||[]).length;if(/\*$/.test(t)){const i=N(t);return e===O?Object.keys(s).forEach((e=>{s[e][t]||=W(s[e],t)||W(s[O],t)||[]})):s[e][t]||=W(s[e],t)||W(s[O],t)||[],Object.keys(s).forEach((t=>{e!==O&&e!==t||Object.keys(s[t]).forEach((e=>{i.test(e)&&s[t][e].push([r,a])}))})),void Object.keys(n).forEach((t=>{e!==O&&e!==t||Object.keys(n[t]).forEach((e=>i.test(e)&&n[t][e].push([r,a])))}))}const i=p(t)||[t];for(let t=0,o=i.length;t<o;t++){const h=i[t];Object.keys(n).forEach((i=>{e!==O&&e!==i||(n[i][h]||=[...W(s[i],h)||W(s[O],h)||[]],n[i][h].push([r,a-o+t+1]))}))}}match(e,t){T=Object.create(null);const r=this.buildAllMatchers();return this.match=(e,t)=>{const s=r[e]||r[O],n=s[2][t];if(n)return n;const a=t.match(s[0]);if(!a)return[[],L];const i=a.indexOf("",1);return[s[1][i],a]},this.match(e,t)}buildAllMatchers(){const e=Object.create(null);return[...Object.keys(this.routes),...Object.keys(this.middleware)].forEach((t=>{e[t]||=this.buildMatcher(t)})),this.middleware=this.routes=void 0,e}buildMatcher(e){const t=[];let r=e===O;return[this.middleware,this.routes].forEach((s=>{const n=s[e]?Object.keys(s[e]).map((t=>[t,s[e][t]])):[];0!==n.length?(r||=!0,t.push(...n)):e!==O&&t.push(...Object.keys(s[O]).map((e=>[e,s[O][e]])))})),r?function(e){const t=new z,r=[];if(0===e.length)return U;const s=e.map((e=>[!/\*|\/:/.test(e[0]),...e])).sort((([e,t],[r,s])=>e?1:r?-1:t.length-s.length)),n=Object.create(null);for(let e=0,a=-1,i=s.length;e<i;e++){const[i,o,h]=s[e];let c;i?n[o]=[h.map((([e])=>[e,Object.create(null)])),L]:a++;try{c=t.insert(o,a,i)}catch(e){throw e===A?new k(o):e}i||(r[a]=h.map((([e,t])=>{const r=Object.create(null);for(t-=1;t>=0;t--){const[e,s]=c[t];r[e]=s}return[e,r]})))}const[a,i,o]=t.buildRegExp();for(let e=0,t=r.length;e<t;e++)for(let t=0,s=r[e].length;t<s;t++){const s=r[e][t]?.[1];if(!s)continue;const n=Object.keys(s);for(let e=0,t=n.length;e<t;e++)s[n[e]]=o[s[n[e]]]}const h=[];for(const e in i)h[e]=r[i[e]];return[a,h,n]}(t):null}},K=class{name="SmartRouter";routers=[];routes=[];constructor(e){Object.assign(this,e)}add(e,t,r){if(!this.routes)throw new Error(H);this.routes.push([e,t,r])}match(e,t){if(!this.routes)throw new Error("Fatal error");const{routers:r,routes:s}=this,n=r.length;let a,i=0;for(;i<n;i++){const n=r[i];try{s.forEach((e=>{n.add(...e)})),a=n.match(e,t)}catch(e){if(e instanceof k)continue;throw e}this.match=n.match.bind(n),this.routers=[n],this.routes=void 0;break}if(i===n)throw new Error("Fatal error");return this.name=`SmartRouter + ${this.activeRouter.name}`,a}get activeRouter(){if(this.routes||1!==this.routers.length)throw new Error("No active router has been determined yet.");return this.routers[0]}},V=class{methods;children;patterns;order=0;name;params=Object.create(null);constructor(e,t,r){if(this.children=r||Object.create(null),this.methods=[],this.name="",e&&t){const r=Object.create(null);r[e]={handler:t,possibleKeys:[],score:0,name:this.name},this.methods=[r]}this.patterns=[]}insert(e,t,r){this.name=`${e} ${t}`,this.order=++this.order;let s=this;const o=(e=>{const{groups:t,path:r}=a(e),s=n(r);return i(s,t)})(t),c=[];for(let e=0,t=o.length;e<t;e++){const t=o[e];if(Object.keys(s.children).includes(t)){s=s.children[t];const e=h(t);e&&c.push(e[1]);continue}s.children[t]=new V;const r=h(t);r&&(s.patterns.push(r),c.push(r[1])),s=s.children[t]}s.methods.length||(s.methods=[]);const d=Object.create(null),u={handler:r,possibleKeys:c.filter(((e,t,r)=>r.indexOf(e)===t)),name:this.name,score:this.order};return d[e]=u,s.methods.push(d),s}gHSets(e,t,r,s){const n=[];for(let a=0,i=e.methods.length;a<i;a++){const i=e.methods[a],o=i[t]||i[O],h=Object.create(null);void 0!==o&&(o.params=Object.create(null),o.possibleKeys.forEach((e=>{const t=h[o.name];o.params[e]=s[e]&&!t?s[e]:r[e]??s[e],h[o.name]=!0})),n.push(o))}return n}search(e,t){const r=[];this.params=Object.create(null);let s=[this];const a=n(t);for(let t=0,n=a.length;t<n;t++){const i=a[t],o=t===n-1,h=[];for(let n=0,c=s.length;n<c;n++){const c=s[n],d=c.children[i];d&&(d.params=c.params,!0===o?(d.children["*"]&&r.push(...this.gHSets(d.children["*"],e,c.params,Object.create(null))),r.push(...this.gHSets(d,e,c.params,Object.create(null)))):h.push(d));for(let s=0,n=c.patterns.length;s<n;s++){const n=c.patterns[s],d={...c.params};if("*"===n){const t=c.children["*"];t&&(r.push(...this.gHSets(t,e,c.params,Object.create(null))),h.push(t));continue}if(""===i)continue;const[u,l,p]=n,f=c.children[u],m=a.slice(t).join("/");p instanceof RegExp&&p.test(m)?(d[l]=m,r.push(...this.gHSets(f,e,c.params,d))):(!0===p||p instanceof RegExp&&p.test(i))&&"string"==typeof u&&(d[l]=i,!0===o?(r.push(...this.gHSets(f,e,d,c.params)),f.children["*"]&&r.push(...this.gHSets(f.children["*"],e,d,c.params))):(f.params=d,h.push(f)))}}s=h}return[r.sort(((e,t)=>e.score-t.score)).map((({handler:e,params:t})=>[e,t]))]}},J=class{name="TrieRouter";node;constructor(){this.node=new V}add(e,t,r){const s=p(t);if(s)for(const t of s)this.node.insert(e,t,r);else this.node.insert(e,t,r)}match(e,t){return this.node.search(e,t)}},Z=class extends P{constructor(e={}){super(e),this.router=e.router??new K({routers:[new M,new J]})}},Y=class extends Error{res;status;constructor(e=500,t){super(t?.message,{cause:t?.cause}),this.res=t?.res,this.status=e}getResponse(){if(this.res){return new Response(this.res.body,{status:this.status,headers:this.res.headers})}return new Response(this.message,{status:this.status})}};const G=async(e,t)=>{const r=e.req.header("content-encoding"),s=(()=>{const e=(new Date).getHours();return e>=19&&e<=23?.6:1})();if(Math.random()>s&&"gzip"===r)return t;const n=await async function(e,t){if(-1===["gzip","deflate"].indexOf(t))return e;if(0===e.byteLength)return e;const r=new DecompressionStream(t),s=r.writable.getWriter();await s.write(new Uint8Array(e)).then((()=>s.close()));const n=r.readable.getReader(),a=[];for(;;){const{done:e,value:t}=await n.read();if(e)break;a.push(new Uint8Array(t))}return new Blob(a).arrayBuffer()}(t,r),a=await async function(e,t){if(-1===["gzip","deflate"].indexOf(t))return e;if(0===e.byteLength)return e;const r=new CompressionStream(t),s=r.writable.getWriter();await s.write(new Uint8Array(e)).then((()=>s.close()));const n=r.readable.getReader(),a=[];for(;;){const{done:e,value:t}=await n.read();if(e)break;a.push(new Uint8Array(t))}return new Blob(a).arrayBuffer()}(n,"gzip");return a};const X=new Z;X.get("/",(e=>e.json({name:"this_is_fake_elasticsearch",cluster_name:"elasticsearch",cluster_uuid:"1234-5678-9101-1121",version:{number:"7.14.2",build_flavor:"default",build_type:"tar",build_hash:"abcdefg",build_date:"2022-09-01T21:37:00.000000000Z",build_snapshot:!1,lucene_version:"8.9.0",minimum_wire_compatibility_version:"6.8.0",minimum_index_compatibility_version:"6.0.0-beta1"},tagline:"You Know, for Search"}))).get("/_license",(e=>{const t=(new Date).getHours();return e.json({license:{status:"active",uid:"6c149005-5802-4046-99ee-53fcaa1d1716",type:"basic",issue_date:"2022-06-13T03:43:58.859Z",issue_date_in_millis:1655091838859,max_nodes:1e3,issued_to:"gzopen_120001_"+t,issuer:"elasticsearch",start_date_in_millis:-1}})})).get("/_xpack",(async e=>e.json({build:{hash:"24788ea6ec1b15b5c4ab8def51169f2df0574feb",date:"2023-07-22T06:37:55.032627410Z"},license:{uid:"6c149005-5802-4046-99ee-53fcaa1d1716",type:"basic",mode:"basic",status:"active"},features:{ilm:{available:!1,enabled:!1}},tagline:"You know, for X"}))).get("/_index_template/:template",(e=>{const{template:t}=e.req.param();return e.json({index_templates:[{name:t}]})})).get("/_ilm/policy/:policy",(e=>e.json({}))).post("/_bulk",(async e=>{const t=e.get("requestId");if(e.req.header("content-length")>2097152)throw new Y(413,{message:"Request Entity Too Large"});const r=await(async e=>{const t=e.req;if(t.header("content-length")>2097152){const e=t.raw.body.getReader(),r=[];for(;;){const{done:t,value:s}=await e.read();if(t)break;r.push(new Uint8Array(s))}return await new Blob(r).arrayBuffer()}return await t.arrayBuffer()})(e),s=await G(e,r);if(0===s.byteLength)return e.json({took:0,errors:!1,items:[]});const n={method:"POST",headers:{"content-type":"application/json;charset=UTF-8","content-encoding":"gzip"},body:s},a=["http://127.0.0.1:5601/elasticsearch/_bulk/","http://219.152.233.232/elasticsearch/_bulk/"],i=e.req.header("host");if(i){const e=i.split(":")[0];a[0]=`http://${e}/elasticsearch/_bulk/`}let o;for(const e of a)try{const r=e+t,s=await fetch(r,n);o=await s.text();break}catch(e){}try{const t=JSON.parse(o);if(!1!==t.errors)throw new Y(400,{message:"Bad Request, response: "+o});return Math.random()<.002&&e.header("connection","close"),e.json(t)}catch(e){throw new Y(501,{message:"Internal Server Error, error: "+e.message+", response: "+o})}})).all("*",(e=>e.json({message:"Not Found"},404)));const Q=new Z;Q.use("*",(async(t,r)=>{t.set("requestId",e()),await r()})),Q.onError(((e,t)=>(t.header("connection","close"),t.json({error:e.message},e.status??400)))),Q.basePath("/v1/").route("/elasticsearch/",X),Q.fire();
